<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>å¿ƒæƒ…æ—¥è¨˜</title>
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#f8bbd0" />
<style>
  :root{
    --pink:#ffb6c1; --pink-dark:#ff80ab; --text:#5b2245; --card:white;
  }
  body{
    font-family:"Microsoft JhengHei",sans-serif;
    margin:0; color:var(--text);
    background:linear-gradient(135deg,#ffd6e8,#f5d0fe);
  }
  header{
    background:rgba(255,255,255,.9);
    padding:14px 16px; text-align:center;
    font-size:22px; font-weight:bold; color:#d81b60;
    box-shadow:0 2px 8px rgba(0,0,0,.1);
  }
  nav{
    position:sticky; top:0; z-index:10;
    display:flex; gap:8px; padding:8px;
    background:rgba(255,255,255,.8); backdrop-filter: blur(6px);
    box-shadow:0 2px 8px rgba(0,0,0,.08);
  }
  nav button{
    flex:1; border:0; padding:10px 0; border-radius:22px;
    background:#fff; color:#d81b60; font-size:16px; cursor:pointer;
  }
  nav button.active{ color:#fff; background:linear-gradient(135deg,var(--pink),var(--pink-dark)); font-weight:700; }
  .container{ max-width:880px; margin:0 auto; padding:16px; }
  .card{
    background:rgba(255,255,255,.95);
    border-radius:20px; padding:16px; margin:14px 0;
    box-shadow:0 6px 20px rgba(0,0,0,.12);
  }
  h2{ margin:0 0 10px; font-size:18px; }
  input,select,textarea{
    width:100%; padding:10px 12px; border-radius:12px;
    border:1px solid #f6a9c1; font-size:15px; background:#fff;
    box-sizing:border-box;
  }
  textarea{ min-height:110px; }
  .btn{
    display:inline-block; border:0; padding:8px 14px; border-radius:14px;
    color:#fff; cursor:pointer; background:linear-gradient(135deg,var(--pink),var(--pink-dark));
    font-size:14px;
  }
  .btn.secondary{ background:#f3e5f5; color:#7b1fa2; }
  .row{ display:flex; gap:10px; }
  .row > *{ flex:1; }
  .emoji-btn{
    font-size:26px; padding:8px; margin:4px;
    background:#fff; border-radius:50%; border:2px solid #f8bbd0; cursor:pointer;
    transition:transform .15s;
  }
  .emoji-btn:hover{ transform:scale(1.1); background:#fde7f0; }
  .list-item{
    background:#fde7f0; border-radius:14px; padding:10px 12px; margin:8px 0;
    display:flex; align-items:center; justify-content:space-between;
  }
  .pill{ padding:6px 10px; border-radius:999px; background:#fff; border:1px solid #f8bbd0; font-size:13px; }
  .muted{ color:#7a5570; font-size:13px; }
  #loginPage{ max-width:420px; margin:auto; padding:18px; }
  .hidden{ display:none; }
  .totals{ display:flex; gap:10px; flex-wrap:wrap; }
  .totals .pill{ background:#fff3f7; }
  .chart-wrap{ display:flex; align-items:center; justify-content:center; }
  svg.pie{ width:240px; height:240px; }
</style>
</head>
<body>
  <header>ğŸŒ¸ å¿ƒæƒ…æ—¥è¨˜</header>

  <!-- ç™»å…¥ / è¨»å†Š -->
  <div id="loginPage" class="container">
    <div class="card">
      <h2>ç™»å…¥ / è¨»å†Š</h2>
      <input id="username" placeholder="å¸³è™Ÿ" />
      <div style="height:8px"></div>
      <input id="password" type="password" placeholder="å¯†ç¢¼" />
      <div style="height:10px"></div>
      <div class="row">
        <button class="btn" onclick="login()">ç™»å…¥</button>
        <button class="btn" onclick="register()">è¨»å†Š</button>
      </div>
      <p id="loginMsg" style="color:#d32f2f"></p>
    </div>
  </div>

  <div id="mainPage" class="hidden">
    <nav>
      <button id="tabMood" class="active" onclick="showTab('mood')">å¿ƒæƒ…</button>
      <button id="tabGoals" onclick="showTab('goals')">ç›®æ¨™</button>
      <button id="tabMoney" onclick="showTab('money')">è¨˜å¸³</button>
      <button id="tabSettings" onclick="showTab('settings')">è¨­å®š</button>
    </nav>

    <div class="container">
      <!-- å¿ƒæƒ… -->
      <section id="pageMood">
        <div class="card">
          <h2>ğŸŒ¼ æ¯æ—¥å¿ƒæƒ…</h2>
          <div class="row">
            <input type="date" id="moodDate" />
            <input id="moodTag" placeholder="ä¸»é¡Œæ¨™ç±¤ï¼ˆå¯é¸ï¼‰" />
          </div>
          <div style="margin:6px 0">
            <button class="emoji-btn" onclick="selectMood(1)">ğŸ˜­</button>
            <button class="emoji-btn" onclick="selectMood(2)">ğŸ˜”</button>
            <button class="emoji-btn" onclick="selectMood(3)">ğŸ™‚</button>
            <button class="emoji-btn" onclick="selectMood(4)">ğŸ˜„</button>
            <button class="emoji-btn" onclick="selectMood(5)">ğŸ˜</button>
            <span class="muted" id="moodScoreHint"></span>
          </div>
          <textarea id="moodText" placeholder="æƒ³æ³•ï¼è¨˜éŒ„"></textarea>
          <div class="row">
            <button class="btn" onclick="saveMood()">å„²å­˜å¿ƒæƒ…</button>
            <button class="btn secondary" onclick="clearMoodInputs()">æ–°å¢/æ¸…ç©º</button>
          </div>
        </div>
        <div class="card">
          <h2>ğŸ—‚ éå»è¨˜éŒ„</h2>
          <div class="row">
            <input id="moodMonthFilter" type="month" />
            <input id="moodTagFilter" placeholder="è¼¸å…¥æ¨™ç±¤é—œéµå­—" />
          </div>
          <div id="moodList"></div>
        </div>
      </section>

      <!-- ç›®æ¨™ -->
      <section id="pageGoals" class="hidden">
        <div class="card">
          <h2>ğŸ“‹ æ¯æ—¥ To-do</h2>
          <div class="row">
            <input id="todoInput" placeholder="è¼¸å…¥å¾…è¾¦äº‹é …" />
            <button class="btn" onclick="addTodo()">æ–°å¢</button>
          </div>
          <div id="todoList"></div>
        </div>

        <div class="card">
          <h2>ğŸ¯ çŸ­æœŸç›®æ¨™</h2>
          <div class="row">
            <input id="shortGoal" placeholder="è¼¸å…¥çŸ­æœŸç›®æ¨™" />
            <button class="btn" onclick="saveGoal('short')">å„²å­˜</button>
          </div>
          <div id="shortGoalList"></div>
        </div>

        <div class="card">
          <h2>ğŸŒŸ é•·æœŸç›®æ¨™</h2>
          <div class="row">
            <input id="longGoal" placeholder="è¼¸å…¥é•·æœŸç›®æ¨™" />
            <button class="btn" onclick="saveGoal('long')">å„²å­˜</button>
          </div>
          <div id="longGoalList"></div>
        </div>
      </section>

      <!-- è¨˜å¸³ -->
      <section id="pageMoney" class="hidden">
        <div class="card">
          <h2>ğŸ’° æ–°å¢è¨˜å¸³</h2>
          <div class="row">
            <input id="moneyDate" type="date" />
            <select id="moneyCategory">
              <option value="é¤é£²">é¤é£²</option>
              <option value="äº¤é€š">äº¤é€š</option>
              <option value="è³¼ç‰©">è³¼ç‰©</option>
              <option value="å¨›æ¨‚">å¨›æ¨‚</option>
              <option value="ç”Ÿæ´»">ç”Ÿæ´»</option>
              <option value="é†«ç™‚">é†«ç™‚</option>
              <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
          </div>
          <div class="row">
            <input id="moneyNote" placeholder="é …ç›®" />
            <input id="moneyAmount" type="number" placeholder="é‡‘é¡" />
          </div>
          <button class="btn" onclick="addMoney()">æ–°å¢è¨˜å¸³</button>
        </div>

        <div class="card">
          <h2>ğŸ“Š è¨˜å¸³æ¸…å–®èˆ‡åˆ†æ</h2>
          <div class="row">
            <input id="moneyMonthFilter" type="month" />
            <select id="moneyCategoryFilter">
              <option value="">å…¨éƒ¨é¡åˆ¥</option>
              <option value="é¤é£²">é¤é£²</option>
              <option value="äº¤é€š">äº¤é€š</option>
              <option value="è³¼ç‰©">è³¼ç‰©</option>
              <option value="å¨›æ¨‚">å¨›æ¨‚</option>
              <option value="ç”Ÿæ´»">ç”Ÿæ´»</option>
              <option value="é†«ç™‚">é†«ç™‚</option>
              <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
          </div>
          <div id="moneyList"></div>
          <div class="totals" id="moneyTotals"></div>
          <div class="chart-wrap">
            <svg id="pieChart" class="pie" viewBox="0 0 200 200"></svg>
          </div>
        </div>
      </section>

      <!-- è¨­å®š -->
      <section id="pageSettings" class="hidden">
        <div class="card">
          <h2>âš™ï¸ è¨­å®š</h2>
          <button class="btn" onclick="clearData()">æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
          <button class="btn" onclick="exportData()">åŒ¯å‡ºè³‡æ–™</button>
          <input type="file" id="importFile" onchange="importData(event)" />
        </div>
        <div class="card">
          <button class="btn" onclick="logout()">ç™»å‡º</button>
        </div>
      </section>
    </div>
  </div>

<script>
// ====== ç™»å…¥ / è¨»å†Š ======
function login(){
  const u = document.getElementById('username').value.trim();
  const p = document.getElementById('password').value;
  const su = localStorage.getItem('diaryUser');
  const sp = localStorage.getItem('diaryPass');
  if(u===su && p===sp){
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('mainPage').classList.remove('hidden');
    initDates(); loadAll();
  }else{
    document.getElementById('loginMsg').innerText='å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤';
  }
}
function register(){
  const u = document.getElementById('username').value.trim();
  const p = document.getElementById('password').value;
  if(!u||!p){ document.getElementById('loginMsg').innerText='è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼'; return; }
  localStorage.setItem('diaryUser',u);
  localStorage.setItem('diaryPass',p);
  document.getElementById('loginMsg').style.color='green';
  document.getElementById('loginMsg').innerText='è¨»å†ŠæˆåŠŸï¼Œè«‹é‡æ–°ç™»å…¥';
}
function logout(){
  document.getElementById('mainPage').classList.add('hidden');
  document.getElementById('loginPage').classList.remove('hidden');
}

// ====== åˆ†é  ======
function showTab(tab){
  ['Mood','Goals','Money','Settings'].forEach(t=>{
    document.getElementById('tab'+t).classList.remove('active');
    document.getElementById('page'+t).classList.add('hidden');
  });
  document.getElementById('tab'+tab.charAt(0).toUpperCase()+tab.slice(1)).classList.add('active');
  document.getElementById('page'+tab.charAt(0).toUpperCase()+tab.slice(1)).classList.remove('hidden');
}

// ====== å¿ƒæƒ… ======
let selectedMood = null;
function selectMood(n){ selectedMood=n; document.getElementById('moodScoreHint').innerText='å·²é¸ï¼š'+n+'/5'; }
function clearMoodInputs(){
  document.getElementById('moodDate').value='';
  document.getElementById('moodTag').value='';
  document.getElementById('moodText').value='';
  selectedMood=null; document.getElementById('moodScoreHint').innerText='';
}
function saveMood(){
  const date=document.getElementById('moodDate').value;
  if(!date || !selectedMood) return;
  const moods=JSON.parse(localStorage.getItem('moods')||'[]');
  moods.push({
    date, tag:document.getElementById('moodTag').value.trim(),
    score:selectedMood, text:document.getElementById('moodText').value.trim()
  });
  localStorage.setItem('moods',JSON.stringify(moods));
  clearMoodInputs(); renderMoods();
}
function renderMoods(){
  const list=document.getElementById('moodList');
  const month=document.getElementById('moodMonthFilter').value;
  const tagKey=(document.getElementById('moodTagFilter').value||'').trim();
  const moods=(JSON.parse(localStorage.getItem('moods')||'[]')).filter(m=>{
    const mth=m.date.slice(0,7);
    const okMonth = !month || mth===month;
    const okTag = !tagKey || (m.tag||'').includes(tagKey);
    return okMonth && okTag;
  }).sort((a,b)=>b.date.localeCompare(a.date));
  list.innerHTML = moods.map((m,i)=>`
    <div class="list-item">
      <div>
        <div><strong>${m.date}</strong>ã€€${m.tag?('<span class="pill">'+m.tag+'</span>'):''}</div>
        <div>åˆ†æ•¸ï¼š${m.score}/5</div>
        <div class="muted">${m.text||''}</div>
      </div>
      <button class="btn" onclick="deleteMood(${i})">åˆªé™¤</button>
    </div>
  `).join('') || '<div class="muted">å°šæœªæœ‰è³‡æ–™ã€‚</div>';
}
function deleteMood(index){
  const moods=JSON.parse(localStorage.getItem('moods')||'[]');
  moods.splice(index,1); localStorage.setItem('moods',JSON.stringify(moods)); renderMoods();
}

// ====== ç›®æ¨™ ======
function saveGoal(type){
  const id = type==='short'?'shortGoal':'longGoal';
  const txt = document.getElementById(id).value.trim();
  if(!txt) return;
  const key = type==='short'?'shortGoals':'longGoals';
  const arr = JSON.parse(localStorage.getItem(key)||'[]'); arr.push(txt);
  localStorage.setItem(key,JSON.stringify(arr));
  document.getElementById(id).value=''; renderGoals();
}
function renderGoals(){
  const short=JSON.parse(localStorage.getItem('shortGoals')||'[]');
  const long =JSON.parse(localStorage.getItem('longGoals')||'[]');
  const shortDOM=document.getElementById('shortGoalList');
  const longDOM =document.getElementById('longGoalList');
  shortDOM.innerHTML = short.map((t,i)=>`
    <div class="list-item">
      <span>${t}</span>
      <div>
        <button class="btn" onclick="completeGoal('short',${i})">å®Œæˆ</button>
        <button class="btn secondary" onclick="deleteGoal('short',${i})">åˆªé™¤</button>
      </div>
    </div>`).join('') || '<div class="muted">å°šæœªæ–°å¢çŸ­æœŸç›®æ¨™</div>';
  longDOM.innerHTML = long.map((t,i)=>`
    <div class="list-item">
      <span>${t}</span>
      <div>
        <button class="btn" onclick="completeGoal('long',${i})">å®Œæˆ</button>
        <button class="btn secondary" onclick="deleteGoal('long',${i})">åˆªé™¤</button>
      </div>
    </div>`).join('') || '<div class="muted">å°šæœªæ–°å¢é•·æœŸç›®æ¨™</div>';
}
function completeGoal(type,i){ deleteGoal(type,i); }
function deleteGoal(type,i){
  const key= type==='short'?'shortGoals':'longGoals';
  const arr=JSON.parse(localStorage.getItem(key)||'[]'); arr.splice(i,1);
  localStorage.setItem(key,JSON.stringify(arr)); renderGoals();
}

// ====== To-do ======
function addTodo(){
  const v=document.getElementById('todoInput').value.trim();
  if(!v) return;
  const todos=JSON.parse(localStorage.getItem('todos')||'[]');
  todos.push({text:v,done:false}); localStorage.setItem('todos',JSON.stringify(todos));
  document.getElementById('todoInput').value=''; renderTodos();
}
function toggleTodo(i){
  const todos=JSON.parse(localStorage.getItem('todos')||'[]');
  todos[i].done=!todos[i].done; localStorage.setItem('todos',JSON.stringify(todos)); renderTodos();
}
function deleteTodo(i){
  const todos=JSON.parse(localStorage.getItem('todos')||'[]');
  todos.splice(i,1); localStorage.setItem('todos',JSON.stringify(todos)); renderTodos();
}
function renderTodos(){
  const todos=JSON.parse(localStorage.getItem('todos')||'[]');
  document.getElementById('todoList').innerHTML = todos.map((t,i)=>`
    <div class="list-item ${t.done?'completed':''}">
      <span>${t.text}</span>
      <div>
        <button class="btn" onclick="toggleTodo(${i})">${t.done?'å–æ¶ˆ':'å®Œæˆ'}</button>
        <button class="btn secondary" onclick="deleteTodo(${i})">åˆªé™¤</button>
      </div>
    </div>
  `).join('') || '<div class="muted">ä»Šå¤©é‚„æ²’æœ‰å¾…è¾¦äº‹é …</div>';
}

// ====== è¨˜å¸³ ======
function addMoney(){
  const date = document.getElementById('moneyDate').value;
  const cat  = document.getElementById('moneyCategory').value;
  const item = document.getElementById('moneyNote').value.trim();
  const amt  = parseFloat(document.getElementById('moneyAmount').value);
  if(!date || !item || isNaN(amt)) return;
  const arr=JSON.parse(localStorage.getItem('money')||'[]');
  arr.push({date, item, amount:amt, category:cat});
  localStorage.setItem('money',JSON.stringify(arr));
  document.getElementById('moneyNote').value=''; document.getElementById('moneyAmount').value='';
  renderMoney();
}
function deleteMoney(i){
  const arr=JSON.parse(localStorage.getItem('money')||'[]'); arr.splice(i,1);
  localStorage.setItem('money',JSON.stringify(arr)); renderMoney();
}
function renderMoney(){
  const month = document.getElementById('moneyMonthFilter').value;
  const catF  = document.getElementById('moneyCategoryFilter').value;
  const all = JSON.parse(localStorage.getItem('money')||'[]').sort((a,b)=>b.date.localeCompare(a.date));
  const rows = all.filter(m=>{
    const okM = !month || m.date.slice(0,7)===month;
    const okC = !catF || m.category===catF;
    return okM && okC;
  });
  document.getElementById('moneyList').innerHTML = rows.map((m,i)=>`
    <div class="list-item">
      <div>
        <div><strong>${m.date}</strong>ã€€<span class="pill">${m.category}</span></div>
        <div>${m.item}</div>
      </div>
      <div>
        <span class="pill">$${m.amount.toFixed(2)}</span>
        <button class="btn secondary" onclick="deleteMoney(${i})">åˆªé™¤</button>
      </div>
    </div>
  `).join('') || '<div class="muted">æœ¬æœˆå°šæœªæœ‰è¨˜å¸³ã€‚</div>';

  const stats = {};
  let total=0;
  rows.forEach(m=>{ stats[m.category]=(stats[m.category]||0)+m.amount; total+=m.amount; });
  const totalsDOM=document.getElementById('moneyTotals');
  totalsDOM.innerHTML = `<span class="pill">ç¸½é¡ï¼š$${total.toFixed(2)}</span>` + 
    Object.entries(stats).map(([k,v])=>`<span class="pill">${k}ï¼š$${v.toFixed(2)}</span>`).join('');
  drawPie('pieChart', stats, total);
}
function drawPie(id, stats, total){
  const svg = document.getElementById(id);
  svg.innerHTML='';
  if(total<=0){ svg.innerHTML='<text x="50" y="105" fill="#7a5570">å°šç„¡è³‡æ–™</text>'; return; }
  let start=0; const cx=100, cy=100, r=90;
  const colors=['#f48fb1','#ce93d8','#ffcc80','#80deea','#c5e1a5','#ffab91','#b0bec5'];
  const entries = Object.entries(stats);
  entries.forEach(([k,v],idx)=>{
    const angle = v/total * 2*Math.PI;
    const x1 = cx + r*Math.cos(start), y1 = cy + r*Math.sin(start);
    const end = start + angle;
    const x2 = cx + r*Math.cos(end), y2 = cy + r*Math.sin(end);
    const large = angle>Math.PI ? 1 : 0;
    const d = [`M ${cx} ${cy}`,`L ${x1} ${y1}`,`A ${r} ${r} 0 ${large} 1 ${x2} ${y2}`,'Z'].join(' ');
    const path=document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d',d);
    path.setAttribute('fill',colors[idx%colors.length]);
    path.setAttribute('stroke','#fff'); path.setAttribute('stroke-width','1');
    svg.appendChild(path);
    start=end;
  });
}

// ====== è¨­å®š ======
function clearData(){
  if(confirm('ç¢ºå®šæ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Ÿ')){
    localStorage.clear(); loadAll(); alert('å·²æ¸…é™¤');
  }
}
function exportData(){
  const data={
    moods:JSON.parse(localStorage.getItem('moods')||'[]'),
    shortGoals:JSON.parse(localStorage.getItem('shortGoals')||'[]'),
    longGoals:JSON.parse(localStorage.getItem('longGoals')||'[]'),
    todos:JSON.parse(localStorage.getItem('todos')||'[]'),
    money:JSON.parse(localStorage.getItem('money')||'[]')
  };
  const blob=new Blob([JSON.stringify(data)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='diary-data.json'; a.click();
}
function importData(e){
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=function(ev){
    try{
      const data=JSON.parse(ev.target.result);
      ['moods','shortGoals','longGoals','todos','money'].forEach(k=>{
        if(data[k]) localStorage.setItem(k,JSON.stringify(data[k]));
      });
      alert('åŒ¯å…¥å®Œæˆ'); loadAll();
    }catch(err){ alert('åŒ¯å…¥å¤±æ•—'); }
  };
  reader.readAsText(file);
}

// ====== åˆå§‹åŒ– ======
function initDates(){
  const today=new Date().toISOString().slice(0,10);
  const ym=today.slice(0,7);
  ['moodDate','moneyDate'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=today; });
  ['moodMonthFilter','moneyMonthFilter'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=ym; });
}
function loadAll(){ renderMoods(); renderGoals(); renderTodos(); renderMoney(); }

// ====== PWA ======
if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js'); }
</script>

</body>
</html>

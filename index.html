<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>å¿ƒæƒ…æ—¥è¨˜</title>
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#f8bbd0" />
<style>
  :root{ --pink:#ffb6c1; --pink-dark:#ff80ab; --text:#5b2245; --card:white; }
  body{ font-family:"Microsoft JhengHei",sans-serif; margin:0; color:var(--text); background:linear-gradient(135deg,#ffd6e8,#f5d0fe); }
  header{ background:rgba(255,255,255,.9); padding:14px 16px; text-align:center; font-size:22px; font-weight:bold; color:#d81b60; box-shadow:0 2px 8px rgba(0,0,0,.1); }
  nav{ position:sticky; top:0; z-index:10; display:flex; gap:8px; padding:8px; background:rgba(255,255,255,.8); backdrop-filter: blur(6px); box-shadow:0 2px 8px rgba(0,0,0,.08); }
  nav button{ flex:1; border:0; padding:10px 0; border-radius:22px; background:#fff; color:#d81b60; font-size:16px; cursor:pointer; }
  nav button.active{ color:#fff; background:linear-gradient(135deg,var(--pink),var(--pink-dark)); font-weight:700; }
  .container{ max-width:880px; margin:0 auto; padding:16px; }
  .card{ background:rgba(255,255,255,.95); border-radius:20px; padding:16px; margin:14px 0; box-shadow:0 6px 20px rgba(0,0,0,.12); }
  h2{ margin:0 0 10px; font-size:18px; }
  input,select,textarea{ width:100%; padding:10px 12px; border-radius:12px; border:1px solid #f6a9c1; font-size:15px; background:#fff; box-sizing:border-box; }
  textarea{ min-height:110px; }
  .btn{ display:inline-block; border:0; padding:8px 14px; border-radius:14px; color:#fff; cursor:pointer; background:linear-gradient(135deg,var(--pink),var(--pink-dark)); font-size:14px; }
  .btn.secondary{ background:#f3e5f5; color:#7b1fa2; }
  .row{ display:flex; gap:10px; }
  .row > *{ flex:1; }
  .emoji-btn{ font-size:26px; padding:8px; margin:4px; background:#fff; border-radius:50%; border:2px solid #f8bbd0; cursor:pointer; transition:transform .15s; }
  .emoji-btn:hover{ transform:scale(1.1); background:#fde7f0; }
  .list-item{ background:#fde7f0; border-radius:14px; padding:10px 12px; margin:8px 0; display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .list-left{ flex:1; min-width:0; }
  .pill{ padding:6px 10px; border-radius:999px; background:#fff; border:1px solid #f8bbd0; font-size:13px; }
  .muted{ color:#7a5570; font-size:13px; }
  #loginPage{ max-width:420px; margin:auto; padding:18px; }
  .hidden{ display:none; }
  .totals{ display:flex; gap:10px; flex-wrap:wrap; }
  .totals .pill{ background:#fff3f7; }
  .chart-wrap{ display:flex; align-items:center; justify-content:center; flex-direction:column; gap:8px; }
  svg.pie{ width:240px; height:240px; }
  .amount{ font-weight:700; }
  .money-actions{ display:flex; gap:6px; align-items:center; }
  .legend{ display:flex; flex-wrap:wrap; gap:6px; justify-content:center; }
  .legend .pill{ display:flex; align-items:center; gap:6px; }
  .swatch{ width:10px; height:10px; border-radius:2px; display:inline-block; }
</style>
</head>
<body>
  <header>ğŸŒ¸ å¿ƒæƒ…æ—¥è¨˜</header>
  <!-- çœç•¥ç™»å…¥å€å¡Šï¼Œä¿æŒä¸è®Š -->

<script>
// è¡Œå‹•è£ç½®ç›¸å®¹ï¼šlocalStorage å›é€€ï¼ˆç„¡ç—•æ¨¡å¼ç­‰ï¼‰
(function(){
  try{ const t='__ls_test__'; localStorage.setItem(t,'1'); localStorage.removeItem(t); window.__MEM_STORAGE__=false; }
  catch(e){ const mem={}; window.__MEM_STORAGE__=true; window.localStorage={ getItem:k=> (k in mem? mem[k]:null), setItem:(k,v)=>{mem[k]=String(v);}, removeItem:k=>{delete mem[k];}, clear:()=>{Object.keys(mem).forEach(k=>delete mem[k]);} }; console.warn('localStorage ä¸å¯ç”¨ï¼šä½¿ç”¨æš«å­˜è¨˜æ†¶é«”ï¼ˆé—œé–‰é é¢å¾Œè³‡æ–™æœƒéºå¤±ï¼‰ã€‚'); }
})();

function genId(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,8); }
function moneyData(){ return JSON.parse(localStorage.getItem('money')||'[]'); }
function setMoneyData(arr){ localStorage.setItem('money',JSON.stringify(arr)); }

// ä¿®æ­£ç‰ˆ addMoneyï¼šé¿å…æ‰‹æ©Ÿè¼¸å…¥éŒ¯èª¤ã€ç¢ºä¿èƒ½æ–°å¢
function addMoney(){
  const date = document.getElementById('moneyDate').value;
  const cat  = document.getElementById('moneyCategory').value;
  const item = document.getElementById('moneyNote').value.trim();
  const raw  = (document.getElementById('moneyAmount').value||'').trim();
  const amt  = parseFloat(raw.replace(',', '.'));
  if(!date || !item || isNaN(amt)) {
    alert('è«‹è¼¸å…¥å®Œæ•´è³‡æ–™ï¼šæ—¥æœŸã€é …ç›®ã€é‡‘é¡');
    return;
  }
  const arr = moneyData();
  arr.push({id:genId(), date, item, amount:amt, category:cat});
  setMoneyData(arr);
  resetMoneyInputs();
  renderMoney();
}

// æ–°å¢ã€Œæœ¬æœˆç¸½èŠ±è²»ã€é¡¯ç¤º
function renderMoney(){
  const month = document.getElementById('moneyMonthFilter') ? document.getElementById('moneyMonthFilter').value : '';
  const catF  = document.getElementById('moneyCategoryFilter') ? document.getElementById('moneyCategoryFilter').value : '';
  const all = moneyData().sort((a,b)=>b.date.localeCompare(a.date));
  const rows = all.filter(m=>{
    const okM = !month || m.date.slice(0,7)===month;
    const okC = !catF || m.category===catF;
    return okM && okC;
  });

  const moneyList=document.getElementById('moneyList');
  if(moneyList){
    moneyList.innerHTML = rows.map((m)=>`
      <div class=\"list-item\" data-id=\"${m.id}\">
        <div class=\"list-left\">
          <div><strong>${m.date}</strong>ã€€<span class=\"pill\">${m.category}</span></div>
          <div class=\"muted\">${m.item}</div>
        </div>
        <div class=\"money-actions\">
          <span class=\"pill amount\">$${fmt(m.amount)}</span>
          <button class=\"btn\" onclick=\"editMoneyById('${m.id}')\">ç·¨è¼¯</button>
          <button class=\"btn secondary\" onclick=\"deleteMoneyById('${m.id}')\">åˆªé™¤</button>
        </div>
      </div>
    `).join('') || '<div class=\"muted\">æœ¬æœˆå°šæœªæœ‰è¨˜å¸³ã€‚</div>';
  }

  // é¡åˆ¥çµ±è¨ˆï¼ˆå—ç•¶å‰ç¯©é¸å½±éŸ¿ï¼‰
  const stats = {}; let total=0;
  rows.forEach(m=>{ stats[m.category]=(stats[m.category]||0)+Number(m.amount)||0; total+=Number(m.amount)||0; });
  const totalsDOM=document.getElementById('moneyTotals');
  if(totalsDOM){
    totalsDOM.innerHTML = `<span class=\"pill\">ç•¶å‰æ¸…å–®ç¸½é¡ï¼š$${fmt(total)}</span>` + 
      Object.entries(stats).map(([k,v])=>`<span class=\"pill\">${k}ï¼š$${fmt(v)}</span>`).join('');
  }
  if(typeof drawPie==='function'){ drawPie('pieChart', stats, total); }

  // æœ¬æœˆç¸½èŠ±è²»ï¼ˆåƒ…ä¾æœˆä»½ï¼Œä¸çœ‹é¡åˆ¥ï¼‰ã€‚åŒæ™‚è‡ªå‹•å»ºç«‹é¡¯ç¤ºå€å¡Šã€‚
  const monthOnly = all.filter(m=> !month || m.date.slice(0,7)===month);
  const monthSum = monthOnly.reduce((s,m)=>s + (Number(m.amount)||0), 0);
  let monthTotalDOM = document.getElementById('monthTotal');
  if(!monthTotalDOM && totalsDOM && totalsDOM.parentNode){
    monthTotalDOM = document.createElement('div');
    monthTotalDOM.id='monthTotal';
    monthTotalDOM.className='totals';
    totalsDOM.parentNode.insertBefore(monthTotalDOM, totalsDOM);
  }
  if(monthTotalDOM){ monthTotalDOM.innerHTML = `<span class=\"pill\">æœ¬æœˆç¸½èŠ±è²»ï¼š$${fmt(monthSum)}</span>`; }
}


function fmt(n){ try{ return Number(n).toLocaleString('zh-TW',{minimumFractionDigits:2, maximumFractionDigits:2}); } catch(e){ return (Number(n)||0).toFixed(2); } }
// è¡Œå‹•è£ç½®ï¼šç¢ºä¿ã€Œæ–°å¢è¨˜å¸³ã€æŒ‰éˆ•åœ¨æ‰‹æ©Ÿå¯è§¸ç™¼
window.addEventListener('DOMContentLoaded', function(){
  var btn = document.getElementById('addMoneyBtn');
  if(btn){
    var handler = function(e){ e.preventDefault(); addMoney(); };
    btn.setAttribute('type','button');
    btn.addEventListener('click', handler);
    btn.addEventListener('touchend', handler);
  }
});
</script>
</body>
</html>

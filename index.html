<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>心情日記</title>
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#f8bbd0" />
<style>
  :root{
    --pink:#ffb6c1; --pink-dark:#ff80ab; --text:#5b2245; --card:white;
  }
  body{
    font-family:"Microsoft JhengHei",sans-serif;
    margin:0; color:var(--text);
    background:linear-gradient(135deg,#ffd6e8,#f5d0fe);
  }
  header{
    background:rgba(255,255,255,.9);
    padding:14px 16px; text-align:center;
    font-size:22px; font-weight:bold; color:#d81b60;
    box-shadow:0 2px 8px rgba(0,0,0,.1);
  }
  nav{
    position:sticky; top:0; z-index:10;
    display:flex; gap:8px; padding:8px;
    background:rgba(255,255,255,.8); backdrop-filter: blur(6px);
    box-shadow:0 2px 8px rgba(0,0,0,.08);
  }
  nav button{
    flex:1; border:0; padding:10px 0; border-radius:22px;
    background:#fff; color:#d81b60; font-size:16px; cursor:pointer;
  }
  nav button.active{ color:#fff; background:linear-gradient(135deg,var(--pink),var(--pink-dark)); font-weight:700; }
  .container{ max-width:880px; margin:0 auto; padding:16px; }
  .card{
    background:rgba(255,255,255,.95);
    border-radius:20px; padding:16px; margin:14px 0;
    box-shadow:0 6px 20px rgba(0,0,0,.12);
  }
  h2{ margin:0 0 10px; font-size:18px; }
  input,select,textarea{
    width:100%; padding:10px 12px; border-radius:12px;
    border:1px solid #f6a9c1; font-size:15px; background:#fff;
    box-sizing:border-box;
  }
  textarea{ min-height:110px; }
  .btn{
    display:inline-block; border:0; padding:8px 14px; border-radius:14px;
    color:#fff; cursor:pointer; background:linear-gradient(135deg,var(--pink),var(--pink-dark));
    font-size:14px;
  }
  .btn.secondary{ background:#f3e5f5; color:#7b1fa2; }
  .row{ display:flex; gap:10px; }
  .row > *{ flex:1; }
  .emoji-btn{
    font-size:26px; padding:8px; margin:4px;
    background:#fff; border-radius:50%; border:2px solid #f8bbd0; cursor:pointer;
    transition:transform .15s;
  }
  .emoji-btn:hover{ transform:scale(1.1); background:#fde7f0; }
  .list-item{
    background:#fde7f0; border-radius:14px; padding:10px 12px; margin:8px 0;
    display:flex; align-items:center; justify-content:space-between;
  }
  .pill{ padding:6px 10px; border-radius:999px; background:#fff; border:1px solid #f8bbd0; font-size:13px; }
  .muted{ color:#7a5570; font-size:13px; }
  #loginPage{ max-width:420px; margin:auto; padding:18px; }
  .hidden{ display:none; }
  .totals{ display:flex; gap:10px; flex-wrap:wrap; }
  .totals .pill{ background:#fff3f7; }
  .chart-wrap{ display:flex; align-items:center; justify-content:center; }
  svg.pie{ width:240px; height:240px; }
</style>
</head>
<body>
  <header>🌸 心情日記</header>

  <!-- 登入 / 註冊 -->
  <div id="loginPage" class="container">
    <div class="card">
      <h2>登入 / 註冊</h2>
      <input id="username" placeholder="帳號" />
      <div style="height:8px"></div>
      <input id="password" type="password" placeholder="密碼" />
      <div style="height:10px"></div>
      <div class="row">
        <button class="btn" onclick="login()">登入</button>
        <button class="btn" onclick="register()">註冊</button>
      </div>
      <p id="loginMsg" style="color:#d32f2f"></p>
    </div>
  </div>

  <div id="mainPage" class="hidden">
    <nav>
      <button id="tabMood" class="active" onclick="showTab('mood')">心情</button>
      <button id="tabGoals" onclick="showTab('goals')">目標</button>
      <button id="tabMoney" onclick="showTab('money')">記帳</button>
      <button id="tabSettings" onclick="showTab('settings')">設定</button>
    </nav>

    <div class="container">
      <!-- 心情 -->
      <section id="pageMood">
        <div class="card">
          <h2>🌼 每日心情</h2>
          <div class="row">
            <input type="date" id="moodDate" />
            <input id="moodTag" placeholder="主題標籤（可選）" />
          </div>
          <div style="margin:6px 0">
            <button class="emoji-btn" onclick="selectMood(1)">😭</button>
            <button class="emoji-btn" onclick="selectMood(2)">😔</button>
            <button class="emoji-btn" onclick="selectMood(3)">🙂</button>
            <button class="emoji-btn" onclick="selectMood(4)">😄</button>
            <button class="emoji-btn" onclick="selectMood(5)">😍</button>
            <span class="muted" id="moodScoreHint"></span>
          </div>
          <textarea id="moodText" placeholder="想法／記錄"></textarea>
          <div class="row">
            <button class="btn" onclick="saveMood()">儲存心情</button>
            <button class="btn secondary" onclick="clearMoodInputs()">新增/清空</button>
          </div>
        </div>
        <div class="card">
          <h2>🗂 過去記錄</h2>
          <div class="row">
            <input id="moodMonthFilter" type="month" />
            <input id="moodTagFilter" placeholder="輸入標籤關鍵字" />
          </div>
          <div id="moodList"></div>
        </div>
      </section>

      <!-- 目標 -->
      <section id="pageGoals" class="hidden">
        <div class="card">
          <h2>📋 每日 To-do</h2>
          <div class="row">
            <input id="todoInput" placeholder="輸入待辦事項" />
            <button class="btn" onclick="addTodo()">新增</button>
          </div>
          <div id="todoList"></div>
        </div>

        <div class="card">
          <h2>🎯 短期目標</h2>
          <div class="row">
            <input id="shortGoal" placeholder="輸入短期目標" />
            <button class="btn" onclick="saveGoal('short')">儲存</button>
          </div>
          <div id="shortGoalList"></div>
        </div>

        <div class="card">
          <h2>🌟 長期目標</h2>
          <div class="row">
            <input id="longGoal" placeholder="輸入長期目標" />
            <button class="btn" onclick="saveGoal('long')">儲存</button>
          </div>
          <div id="longGoalList"></div>
        </div>
      </section>

      <!-- 記帳 -->
      <section id="pageMoney" class="hidden">
        <div class="card">
          <h2>💰 新增記帳</h2>
          <div class="row">
            <input id="moneyDate" type="date" />
            <select id="moneyCategory">
              <option value="餐飲">餐飲</option>
              <option value="交通">交通</option>
              <option value="購物">購物</option>
              <option value="娛樂">娛樂</option>
              <option value="生活">生活</option>
              <option value="醫療">醫療</option>
              <option value="其他">其他</option>
            </select>
          </div>
          <div class="row">
            <input id="moneyNote" placeholder="項目" />
            <input id="moneyAmount" type="number" placeholder="金額" />
          </div>
          <button class="btn" onclick="addMoney()">新增記帳</button>
        </div>

        <div class="card">
          <h2>📊 記帳清單與分析</h2>
          <div class="row">
            <input id="moneyMonthFilter" type="month" />
            <select id="moneyCategoryFilter">
              <option value="">全部類別</option>
              <option value="餐飲">餐飲</option>
              <option value="交通">交通</option>
              <option value="購物">購物</option>
              <option value="娛樂">娛樂</option>
              <option value="生活">生活</option>
              <option value="醫療">醫療</option>
              <option value="其他">其他</option>
            </select>
          </div>
          <div id="moneyList"></div>
          <div class="totals" id="moneyTotals"></div>
          <div class="chart-wrap">
            <svg id="pieChart" class="pie" viewBox="0 0 200 200"></svg>
          </div>
        </div>
      </section>

      <!-- 設定 -->
      <section id="pageSettings" class="hidden">
        <div class="card">
          <h2>⚙️ 設定</h2>
          <button class="btn" onclick="clearData()">清除所有資料</button>
          <button class="btn" onclick="exportData()">匯出資料</button>
          <input type="file" id="importFile" onchange="importData(event)" />
        </div>
        <div class="card">
          <button class="btn" onclick="logout()">登出</button>
        </div>
      </section>
    </div>
  </div>

<script>
// ====== 登入 / 註冊 ======
function login(){
  const u = document.getElementById('username').value.trim();
  const p = document.getElementById('password').value;
  const su = localStorage.getItem('diaryUser');
  const sp = localStorage.getItem('diaryPass');
  if(u===su && p===sp){
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('mainPage').classList.remove('hidden');
    initDates(); loadAll();
  }else{
    document.getElementById('loginMsg').innerText='帳號或密碼錯誤';
  }
}
function register(){
  const u = document.getElementById('username').value.trim();
  const p = document.getElementById('password').value;
  if(!u||!p){ document.getElementById('loginMsg').innerText='請輸入帳號和密碼'; return; }
  localStorage.setItem('diaryUser',u);
  localStorage.setItem('diaryPass',p);
  document.getElementById('loginMsg').style.color='green';
  document.getElementById('loginMsg').innerText='註冊成功，請重新登入';
}
function logout(){
  document.getElementById('mainPage').classList.add('hidden');
  document.getElementById('loginPage').classList.remove('hidden');
}

// ====== 分頁 ======
function showTab(tab){
  ['Mood','Goals','Money','Settings'].forEach(t=>{
    document.getElementById('tab'+t).classList.remove('active');
    document.getElementById('page'+t).classList.add('hidden');
  });
  document.getElementById('tab'+tab.charAt(0).toUpperCase()+tab.slice(1)).classList.add('active');
  document.getElementById('page'+tab.charAt(0).toUpperCase()+tab.slice(1)).classList.remove('hidden');
}

// ====== 心情 ======
let selectedMood = null;
function selectMood(n){ selectedMood=n; document.getElementById('moodScoreHint').innerText='已選：'+n+'/5'; }
function clearMoodInputs(){
  document.getElementById('moodDate').value='';
  document.getElementById('moodTag').value='';
  document.getElementById('moodText').value='';
  selectedMood=null; document.getElementById('moodScoreHint').innerText='';
}
function saveMood(){
  const date=document.getElementById('moodDate').value;
  if(!date || !selectedMood) return;
  const moods=JSON.parse(localStorage.getItem('moods')||'[]');
  moods.push({
    date, tag:document.getElementById('moodTag').value.trim(),
    score:selectedMood, text:document.getElementById('moodText').value.trim()
  });
  localStorage.setItem('moods',JSON.stringify(moods));
  clearMoodInputs(); renderMoods();
}
function renderMoods(){
  const list=document.getElementById('moodList');
  const month=document.getElementById('moodMonthFilter').value;
  const tagKey=(document.getElementById('moodTagFilter').value||'').trim();
  const moods=(JSON.parse(localStorage.getItem('moods')||'[]')).filter(m=>{
    const mth=m.date.slice(0,7);
    const okMonth = !month || mth===month;
    const okTag = !tagKey || (m.tag||'').includes(tagKey);
    return okMonth && okTag;
  }).sort((a,b)=>b.date.localeCompare(a.date));
  list.innerHTML = moods.map((m,i)=>`
    <div class="list-item">
      <div>
        <div><strong>${m.date}</strong>　${m.tag?('<span class="pill">'+m.tag+'</span>'):''}</div>
        <div>分數：${m.score}/5</div>
        <div class="muted">${m.text||''}</div>
      </div>
      <button class="btn" onclick="deleteMood(${i})">刪除</button>
    </div>
  `).join('') || '<div class="muted">尚未有資料。</div>';
}
function deleteMood(index){
  const moods=JSON.parse(localStorage.getItem('moods')||'[]');
  moods.splice(index,1); localStorage.setItem('moods',JSON.stringify(moods)); renderMoods();
}

// ====== 目標 ======
function saveGoal(type){
  const id = type==='short'?'shortGoal':'longGoal';
  const txt = document.getElementById(id).value.trim();
  if(!txt) return;
  const key = type==='short'?'shortGoals':'longGoals';
  const arr = JSON.parse(localStorage.getItem(key)||'[]'); arr.push(txt);
  localStorage.setItem(key,JSON.stringify(arr));
  document.getElementById(id).value=''; renderGoals();
}
function renderGoals(){
  const short=JSON.parse(localStorage.getItem('shortGoals')||'[]');
  const long =JSON.parse(localStorage.getItem('longGoals')||'[]');
  const shortDOM=document.getElementById('shortGoalList');
  const longDOM =document.getElementById('longGoalList');
  shortDOM.innerHTML = short.map((t,i)=>`
    <div class="list-item">
      <span>${t}</span>
      <div>
        <button class="btn" onclick="completeGoal('short',${i})">完成</button>
        <button class="btn secondary" onclick="deleteGoal('short',${i})">刪除</button>
      </div>
    </div>`).join('') || '<div class="muted">尚未新增短期目標</div>';
  longDOM.innerHTML = long.map((t,i)=>`
    <div class="list-item">
      <span>${t}</span>
      <div>
        <button class="btn" onclick="completeGoal('long',${i})">完成</button>
        <button class="btn secondary" onclick="deleteGoal('long',${i})">刪除</button>
      </div>
    </div>`).join('') || '<div class="muted">尚未新增長期目標</div>';
}
function completeGoal(type,i){ deleteGoal(type,i); }
function deleteGoal(type,i){
  const key= type==='short'?'shortGoals':'longGoals';
  const arr=JSON.parse(localStorage.getItem(key)||'[]'); arr.splice(i,1);
  localStorage.setItem(key,JSON.stringify(arr)); renderGoals();
}

// ====== To-do ======
function addTodo(){
  const v=document.getElementById('todoInput').value.trim();
  if(!v) return;
  const todos=JSON.parse(localStorage.getItem('todos')||'[]');
  todos.push({text:v,done:false}); localStorage.setItem('todos',JSON.stringify(todos));
  document.getElementById('todoInput').value=''; renderTodos();
}
function toggleTodo(i){
  const todos=JSON.parse(localStorage.getItem('todos')||'[]');
  todos[i].done=!todos[i].done; localStorage.setItem('todos',JSON.stringify(todos)); renderTodos();
}
function deleteTodo(i){
  const todos=JSON.parse(localStorage.getItem('todos')||'[]');
  todos.splice(i,1); localStorage.setItem('todos',JSON.stringify(todos)); renderTodos();
}
function renderTodos(){
  const todos=JSON.parse(localStorage.getItem('todos')||'[]');
  document.getElementById('todoList').innerHTML = todos.map((t,i)=>`
    <div class="list-item ${t.done?'completed':''}">
      <span>${t.text}</span>
      <div>
        <button class="btn" onclick="toggleTodo(${i})">${t.done?'取消':'完成'}</button>
        <button class="btn secondary" onclick="deleteTodo(${i})">刪除</button>
      </div>
    </div>
  `).join('') || '<div class="muted">今天還沒有待辦事項</div>';
}

// ====== 記帳 ======
function addMoney(){
  const date = document.getElementById('moneyDate').value;
  const cat  = document.getElementById('moneyCategory').value;
  const item = document.getElementById('moneyNote').value.trim();
  const amt  = parseFloat(document.getElementById('moneyAmount').value);
  if(!date || !item || isNaN(amt)) return;
  const arr=JSON.parse(localStorage.getItem('money')||'[]');
  arr.push({date, item, amount:amt, category:cat});
  localStorage.setItem('money',JSON.stringify(arr));
  document.getElementById('moneyNote').value=''; document.getElementById('moneyAmount').value='';
  renderMoney();
}
function deleteMoney(i){
  const arr=JSON.parse(localStorage.getItem('money')||'[]'); arr.splice(i,1);
  localStorage.setItem('money',JSON.stringify(arr)); renderMoney();
}
function renderMoney(){
  const month = document.getElementById('moneyMonthFilter').value;
  const catF  = document.getElementById('moneyCategoryFilter').value;
  const all = JSON.parse(localStorage.getItem('money')||'[]').sort((a,b)=>b.date.localeCompare(a.date));
  const rows = all.filter(m=>{
    const okM = !month || m.date.slice(0,7)===month;
    const okC = !catF || m.category===catF;
    return okM && okC;
  });
  document.getElementById('moneyList').innerHTML = rows.map((m,i)=>`
    <div class="list-item">
      <div>
        <div><strong>${m.date}</strong>　<span class="pill">${m.category}</span></div>
        <div>${m.item}</div>
      </div>
      <div>
        <span class="pill">$${m.amount.toFixed(2)}</span>
        <button class="btn secondary" onclick="deleteMoney(${i})">刪除</button>
      </div>
    </div>
  `).join('') || '<div class="muted">本月尚未有記帳。</div>';

  const stats = {};
  let total=0;
  rows.forEach(m=>{ stats[m.category]=(stats[m.category]||0)+m.amount; total+=m.amount; });
  const totalsDOM=document.getElementById('moneyTotals');
  totalsDOM.innerHTML = `<span class="pill">總額：$${total.toFixed(2)}</span>` + 
    Object.entries(stats).map(([k,v])=>`<span class="pill">${k}：$${v.toFixed(2)}</span>`).join('');
  drawPie('pieChart', stats, total);
}
function drawPie(id, stats, total){
  const svg = document.getElementById(id);
  svg.innerHTML='';
  if(total<=0){ svg.innerHTML='<text x="50" y="105" fill="#7a5570">尚無資料</text>'; return; }
  let start=0; const cx=100, cy=100, r=90;
  const colors=['#f48fb1','#ce93d8','#ffcc80','#80deea','#c5e1a5','#ffab91','#b0bec5'];
  const entries = Object.entries(stats);
  entries.forEach(([k,v],idx)=>{
    const angle = v/total * 2*Math.PI;
    const x1 = cx + r*Math.cos(start), y1 = cy + r*Math.sin(start);
    const end = start + angle;
    const x2 = cx + r*Math.cos(end), y2 = cy + r*Math.sin(end);
    const large = angle>Math.PI ? 1 : 0;
    const d = [`M ${cx} ${cy}`,`L ${x1} ${y1}`,`A ${r} ${r} 0 ${large} 1 ${x2} ${y2}`,'Z'].join(' ');
    const path=document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d',d);
    path.setAttribute('fill',colors[idx%colors.length]);
    path.setAttribute('stroke','#fff'); path.setAttribute('stroke-width','1');
    svg.appendChild(path);
    start=end;
  });
}

// ====== 設定 ======
function clearData(){
  if(confirm('確定清除所有資料？')){
    localStorage.clear(); loadAll(); alert('已清除');
  }
}
function exportData(){
  const data={
    moods:JSON.parse(localStorage.getItem('moods')||'[]'),
    shortGoals:JSON.parse(localStorage.getItem('shortGoals')||'[]'),
    longGoals:JSON.parse(localStorage.getItem('longGoals')||'[]'),
    todos:JSON.parse(localStorage.getItem('todos')||'[]'),
    money:JSON.parse(localStorage.getItem('money')||'[]')
  };
  const blob=new Blob([JSON.stringify(data)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='diary-data.json'; a.click();
}
function importData(e){
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=function(ev){
    try{
      const data=JSON.parse(ev.target.result);
      ['moods','shortGoals','longGoals','todos','money'].forEach(k=>{
        if(data[k]) localStorage.setItem(k,JSON.stringify(data[k]));
      });
      alert('匯入完成'); loadAll();
    }catch(err){ alert('匯入失敗'); }
  };
  reader.readAsText(file);
}

// ====== 初始化 ======
function initDates(){
  const today=new Date().toISOString().slice(0,10);
  const ym=today.slice(0,7);
  ['moodDate','moneyDate'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=today; });
  ['moodMonthFilter','moneyMonthFilter'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=ym; });
}
function loadAll(){ renderMoods(); renderGoals(); renderTodos(); renderMoney(); }

// ====== PWA ======
if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js'); }
</script>

</body>
</html>
